window.pusher = {}
window.room ?= {}
window.room.voicesController ?= {}

$ ->

  window.pusher = new Pusher('<%= Pusher.key %>', { authEndpoint: '/pusher/auth' });
  channel = window.pusher.subscribe('presence-room-1');

  # generate voices given member-voice objects
  channel.bind 'pusher:subscription_succeeded', (members)->
    console.log 'subscription_succeeded'
    voices = []
    members.each (member)->
      voices.push member.info.voice
    window.room.voicesController = new VoicesController(voices)

  # create a new voice
  channel.bind 'pusher:member_added', (member) ->
    console.log 'pusher:member_added'
    window.room.voicesController.addVoice(member.info.voice)
    
  # destroy voice 
  channel.bind 'pusher:member_removed', (member) -> 
    console.log 'pusher:member_removed'
    window.room.voicesController.removeVoice(member.info.voice)
